OT2.Basket=function(){function e(t){return this instanceof e?(OT2.Event.call(this),this.el=t||document.createElement("div"),this.$el=$(this.el),this.$list=this.$el.find(".basket-count"),this.isVisible=this.$el.hasClass("active"),this.activeClass="active",this.model=[],this.cacheObj={},this.unserialize(),this.render(),this.bindEvent(),void(this.wireIframe=OT2.Wireiframe())):new e(t)}var t=_.template(OT2.Util.Template().get("basketList"));return e.prototype={changeVisual:function(){this.isVisible=!this.isVisible,this.$el[this.isVisible?"addClass":"removeClass"](this.activeClass)},bindEvent:function(){var e=this;this.$el.find(".basket-tit").on("click",function(){e.changeVisual()}),e.subscribe("Question:add",function(t){if(e.unserialize(),_.contains(e.model,t.id))return!1;e.model.push(t.id);var i=_.pluck(e.cacheObj,"order"),n=_.size(i)?Number(_.max(i)):0;e.cacheObj[t.id]={id:t.id,type:t.type,xd:t.xd,xk:t.xk,order:n+1},e.serialize()}),e.subscribe("Question:move",function(t){e.wireIframe.move(t,e)}),e.subscribe("Question:remove",function(t){e.unserialize(),e.model=_.without(e.model,t.id),e.cacheObj[t.id]&&delete e.cacheObj[t.id],e.serialize()})},getPosition:function(){var e=this.$el.offset(),t=this.$el.width();this.$el.height();return{left:e.left+t,top:e.top}},serialize:function(){OT2.LocalData.set("basket_cacheObj_v2",JSON3.stringify(this.cacheObj)),this.render()},unserialize:function(){this.cacheObj={};try{this.cacheObj=JSON3.parse(OT2.LocalData.get("basket_cacheObj_v2"))||{}}catch(e){}this.model=[],this.model=_.chain(this.cacheObj).sortBy("order").map(function(e){return e.id}).value()},render_old:function(){this.$list.empty();for(var e,i={},n=0,a=0;e=this.model[a++];){var s=this.cacheObj[e];if(s&&("undefined"==typeof OT2.xd_chid||s.xk==OT2.xd_chid.chid&&s.xd==OT2.xd_chid.xd)){var d=s.type;"undefined"==typeof i[d]?i[d]=[e]:i[d].push(e),n++}}var o=_.map(i,function(e,t){return{key:t,val:e,id:1e3}});if("undefined"!=typeof PARAMS&&PARAMS.question_types){var l=_.invert(PARAMS.question_types);o=_.map(i,function(e,t){var i=l[t]?Number(l[t]):1e3;return{key:t,val:e,id:i}}),o=o.sort(function(e,t){return e.id-t.id})}this.$list.append(t({num:n,list:o}))},render:function(){for(var e,i=[],n=0,a=0;e=this.model[a++];){var s=this.cacheObj[e];s&&("undefined"==typeof OT2.xd_chid||s.xk==OT2.xd_chid.chid&&s.xd==OT2.xd_chid.xd)&&(i.push(s),n++)}try{i=_.sortBy(i,"order2");var d=_.uniq(_.pluck(i,"type")),o=_.groupBy(i,"type"),l=_.map(d,function(e){return{key:e,val:_.pluck(o[e],"id")}})}catch(r){i=_.sortBy(i,"order");var l=_.map(PARAMS.sortQuestionTypes,function(e){var t=e.name;return{key:t,val:_.chain(i).filter(function(e){return e.type==t}).pluck("id").value()}});l=_.filter(l,function(e){return _.size(e.val)})}this.$list.html(t({num:n,list:l}))},getLenght:function(e){var t=0;for(var i in e)t++;return t},removeAll:function(e){var t=this,i=[].slice.call(arguments,1),n=dialog({title:"友情提示",content:'你确定要删除"'+e+'"吗?',padding:20,okValue:"确定",cancelValue:"取消",ok:function(){_ids=_.map(i,function(e){return e+""}),t.model=_.difference(t.model,i),t.model=_.difference(t.model,_ids);for(var n,a=0;n=i[a++];)t.publish("remove:byid",n),delete t.cacheObj[n];t.deleteQtypeWithXdXk(e),t.serialize()},cancel:function(){this.close()}});n.showModal()},addAll:function(e){var t=this;t.unserialize();for(var i,n=_.pluck(t.cacheObj,"order"),a=_.size(n)?Number(_.max(n)):0,s=0;i=e[s++];)if(!_.contains(t.model,i.model.id)){if("undefined"!=typeof OT2.xd_chid)var d=_.filter(t.cacheObj,function(e){return e.xk==OT2.xd_chid.chid&&e.xd==OT2.xd_chid.xd}).length;else var d=t.model.length;if("undefined"==typeof USER.basketLimit&&(USER.basketLimit=30),d>=USER.basketLimit){var o="抱歉，您的试题篮最多可选"+USER.basketLimit+"道试题";USER.isVip||0!=USER.school_permit_id||(o+='</br><span style="color:#666666;font-size:12px">vip用户可选50道试题，<a href="/payment/vip" target="_blank" class="notice-pjq">开通vip</a><span>'),OT2.Util.alert(o,1);break}t.publish("add:byid",i.model.id),t.cacheObj[i.model.id]={id:i.model.id,type:i.model.type,xd:i.model.xd,xk:i.model.xk,order:a+1}}t.model=_.chain(t.cacheObj).sortBy("order").map(function(e){return e.id}).value(),t.serialize()},deleteQtypeWithXdXk:function(e){var t="";if("undefined"!=typeof OT2.xd_chid){var i=OT2.xd_chid.xd,n=OT2.xd_chid.chid,t=["paper2016",i,n].join(":"),a=OT2.LocalData.get(t);if(!a||0==a.length)return!1;var s={};try{s=JSON3.parse(a)||{}}catch(d){}"undefined"!=typeof s.types&&"undefined"!=typeof s.types[e]&&(delete s.types[e],OT2.LocalData.set(t,JSON3.stringify(s)))}}},_.extend(e.prototype,OT2.Event.prototype),e}(),OT2.Wireiframe=function(){var e=null;return function(){return e||(e={$el:$("<div>"),init:function(){this.$el.css({position:"absolute",display:"none"}),this.$el.appendTo(document.body)},move:function(e,t){var i=e.$el,n=i.position(),a=i.width(),s=i.height();this.$el.css({width:a,height:s,left:n.left,top:n.top,opacity:1}),this.$el.show();var d=t.getPosition();d.width=0,d.height=0,this.$el.append(i.clone(!1));var o=Math.abs(d.left-n.left),l=Math.abs(d.top-n.top),r=Math.sqrt(o*o+l*l)/2.5;this.$el.animate(d,r,function(){$(this).empty(),$(this).hide()})}}),e.init(),e}}(),OT2.Question=function(){var e=_.template(OT2.Util.Template().get("question-item")),t=_.template(OT2.Util.Template().get("exam-point")),i=_.template(OT2.Util.Template().get("exam-answer")),n=_.template(OT2.Util.Template().get("exam-explanation")),a=(_.template(OT2.Util.Template().get("exan-temp")),function(e,t){this.basket=t,this.model={added:!1},"undefined"!=typeof e.added&&(this.model.added=e.added),_.extend(this.model,e),this.$el=null,this.$addBtn=null,this.visibled_analyticbox=!1,this.rendered_analyticbox=!1});return a.prototype={render:function(t){var i=this;if(t)this.$el=t,this.basket.subscribe("question:width",function(){i.$el.find(".exam-s").each(function(){OT2.Util.calcItemWidth($(this))})});else{var n=$(e(this.model)),a=new OT2.QuestionTxt(this.model,this.basket);a.render(),n.find(".exam-head").after(a.$el),this.$el=n}return this.cacheElements(),this.bindEvent(),this},show_analyticbox:function(){var e="undefined"==typeof USER?{uid:null}:USER;if(this.rendered_analyticbox===!1&&this.visibled_analyticbox===!0){this.rendered_analyticbox=!0,this.$el.find(".exam-foot").before('<div class="analyticbox-brick"></div>');var a=t({q:this.model,user:e});this.$el.find(".analyticbox-brick").append(a),"7"==this.model.question_type?(a=_.map(this.model.list,function(t,n){return i({q:t,user:e})}),this.$el.find(".exam-qlist > .exam-con").each(function(e,t){$(this).after(a[e])})):(this.$el.find(".analyticbox-brick").addClass("analyticbox-brick-normal"),a=i({q:this.model,user:e}),this.$el.find(".analyticbox-brick").append(a)),a=n({q:this.model,user:e}),this.$el.find(".analyticbox-brick").append(a),this.$el.addClass(this.model.explanation?"beauty-man":"uglify-man")}this.$el[this.visibled_analyticbox?"addClass":"removeClass"]("visible-ake"),this.$el.find(".analyticbox, .analyticbox-brick")[this.visibled_analyticbox?"show":"hide"]()},cacheElements:function(){this.$addBtn=this.$el.find(".J_AddQuestion")},addToBasket:function(){this.model.added=!0,this.$addBtn.html("<b>-</b>移除"),this.$addBtn.addClass("removebtn"),this.$addBtn.removeClass("addbtn")},removeFromBasket:function(){this.model.added=!1,this.$addBtn.html("<b>+</b>选题"),this.$addBtn.removeClass("removebtn"),this.$addBtn.addClass("addbtn")},addOrRemove:function(e){if(!this.model.added||e&&"undefined"!=typeof e){var t=this.countQnumsByChid();if("undefined"==typeof USER.basketLimit&&(USER.basketLimit=30),t>=USER.basketLimit){var i="抱歉，您的试题篮最多可选"+USER.basketLimit+"道试题";return USER.isVip||0!=USER.school_permit_id||(i+='</br><span style="color:#666666;font-size:12px">vip用户可选50道试题，<a href="/payment/vip" target="_blank" class="notice-pjq">开通vip</a><span>'),OT2.Util.alert(i,1),!1}this.addToBasket(),this.basket.publish("Question:add",this.model),this.basket.publish("Question:move",this)}else this.removeFromBasket(),this.basket.publish("Question:remove",this.model)},countQnumsByChid:function(){return"undefined"!=typeof OT2.xd_chid?_.filter(this.basket.cacheObj,function(e){return e.xk==OT2.xd_chid.chid&&e.xd==OT2.xd_chid.xd}).length:this.basket.model.length},bindEvent:function(){var e=this;this.$addBtn.on("click",function(){return"undefined"==typeof USER.uid?OT2.Global.initLogin():void e.addOrRemove()}),this.basket.subscribe("remove:byid",function(t){return t==e.model.id&&(e.basket.model=_.without(e.basket.model,t),e.basket.model=_.without(e.basket.model,""+t),void e.removeFromBasket())}),this.basket.subscribe("add:byid",function(t){return t==e.model.id&&void e.addToBasket()}),this.$el.find(".search-exam").children(".exam-con").on("click",function(t){e.visibled_analyticbox=!e.visibled_analyticbox,e.show_analyticbox()}),this.basket.subscribe("show-analyticbox",function(t){e.visibled_analyticbox=t,e.show_analyticbox()})}},a}();