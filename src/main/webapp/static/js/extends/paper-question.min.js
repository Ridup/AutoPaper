function _getElementTop(e){for(var t=e.offsetTop,i=e.offsetParent;null!=i;)t+=i.offsetTop+i.clientTop,i=i.offsetParent;return t}OT2.Paper.Question=function(){var e=function(e,t,i,s){this.$el=null,this.paper=e,this.section=t||null,this.model=i,this.attributes={id:0,type:null,score:0,subScore:[],order:0},this.attributes=$.extend(!0,{},this.attributes,i.score),this.attributes=$.extend(!0,{},this.attributes,s),this.paper.cacheObj[this.model.id]=this.attributes,this.enableSortable=!1,this.template=OT2.Util.Template().get("paper-question"),this.init()};return e.zIndex=100,e.prototype={init:function(){this.render(),this.bindEvents(),this.listen(),this.sortable()},initScore:function(){var e=0;if(Number(this.model.question_type)<6)switch(this.model.question_type){case"1":e=2;break;case"2":e=3;break;case"3":case"4":e=2;break;case"5":e=5}else"7"==this.model.question_type?_.each(this.model.list,function(t,i){if(Number(t.question_type)<6)switch(t.question_type){case"1":e+=2;break;case"2":e+=3;break;case"3":case"4":e+=2;break;case"5":e+=5}else"6"==t.question_type&&(e+=1*t.options.length)}):6==Number(this.model.question_type)&&(e=1*this.model.options.length);return e},render:function(e){if(e)this.$el=e;else{this.$el=$(_.template(this.template,{self:this}));this.model.index=this.attributes.order,this.model.q=this;var t=new OT2.QuestionTxt(this.model,this.paper,{className:".op-items"});t.render(),this.$el.prepend(t.$el)}return this},serialize:function(){this.paper.cacheObj[this.model.id]=this.attributes,this.paper.serialize()},listen:function(){var e=this;this.paper.subscribe("question:sum",function(t,i){e.section===t&&i.push(e)}),this.paper.subscribe("question:list",function(t,i){e.paper==t&&i.push(e)}),this.paper.subscribe("question:changeType",function(t,i){e.attributes.type==i&&(e.attributes.type=t,e.paper.cacheObj[e.attributes.id].type=t,e.paper.serialize())}),this.paper.subscribe("question:deleteBatch",function(t){if(e.attributes.type!=t)return!1;void 0!==e.paper&&null!=e.paper&&e.paper.publish("question:destroyBatch",e)}),this.paper.subscribe("question:setorder",function(t,i){if(e.$el.attr("id")==t){e.attributes.order=i;var s=e.paper.cacheObj[e.attributes.id];s&&(s.order=i)}}),this.paper.subscribe("question:sort",function(t,i){if(t!=e.attributes.type)return!1;e.enableSortable="enable"==i}),this.section.subscribe("section:multi:setscore",function(t,i){var s=e.model.question_channel_type,n=e.model.question_type;if(6==n||7==n)return!1;if([n,s].join(",")!=i)return!1;var a=t;4==n&&(a=t*_.size(e.model.myanswer)),e.attributes.score=a,e.attributes.subScore=[t],e.serialize(),e.$el.find(".q-scoreval").html("（"+a+"分）"),e.section.publish("section:score"),e.paper.renderSideTypes()}),this.paper.subscribe("question:scrolltoview",function(t){e.model.question_id==t&&e.scrollToView()})},scrollToView:function(){var e=this,t=$(document.body||document.documentElement).scrollTop(),i=$(window).height(),s=0;((s=_getElementTop(e.$el.get(0)))<t+i/3||s>t+i/3)&&(s-=i/3,$("html,body").animate({scrollTop:s},"slow")),e.$el.css("background-color","#cee5db"),setTimeout(function(){e.$el.css("background-color","#ffffff")},1500)},bindEvents:function(){var e=this;this.$el.find(".del-btn").on("click",function(){e.$el.fadeOut(function(){$(this).remove(),e.paper.publish("question:destroy",e)})}),this.$el.find(".zy-btn").on("click",function(){e.transfer().done(function(t){t&&t!=e.attributes.type&&e.paper.publish("question:transfer",e,e.attributes.type,t)})}),this.$el.find(".ht-btn").on("click",function(){var t,i=e.paper,s={id:e.attributes.id,ids:i.basketQids};$.ajax({type:"POST",url:"/question/relation",dataType:"json",data:{id:e.attributes.id,ids:i.basketQids},beforeSend:function(){t=OT2.Util.alert("正在换题中",1)},success:function(n){if(t.remove(),0!==n.errCode)return!1;var a=s=n.data.data;if(!s)return OT2.Util.alert("抱歉，没有类似试题可换！"),!1;var r=_.template(OT2.Util.Template().get("replace-question")),o=_.template(OT2.Util.Template().get("question-item")),l=_.template(OT2.Util.Template().get("detail-txt")),c=_.template(OT2.Util.Template().get("exam-answer")),u=(_.template(OT2.Util.Template().get("exam-explanation")),_.template(OT2.Util.Template().get("exam-point")),PARAMS.question_types),p=PARAMS.difficult_indexs,d=PARAMS.exam_types;$.each(s.questions,function(e,t){if(t.id=t.question_id,t.type=u[t.question_channel_type],t.exam_type=d[t.exam_type],t.difficult_index=p[t.difficult_index],t.question_from=t.paper?'试题来源：<a href="/paper/view/'+t.paperid+'" target="_blank">'+t.paper.title+"</a>":"暂无来源",t.is_collect=t.is_collect?"取消收藏":"收藏",t.q_list="",7==t.question_type){var i="";$.each(t.list,function(e,t){t=$.extend({},t,{index:e}),i+=l(t),i+=c({q:t})}),t.q_list=i}});var f=r({html:o({data:s,user:USER}),len:n.data.len,count:n.data.count});$(document.body).append(f),setTimeout(function(){$(".p-replace-wrap").addClass("mactive"),$(document.body).css({"overflow-y":"hidden"})},100),$(".change-btn").on("click",function(){$.ajax({type:"POST",url:"/question/relation",dataType:"json",data:{id:e.attributes.id,ids:i.basketQids},beforeSend:function(){t=$(".loading1").show()},success:function(e){if(t.hide(),0!==e.errCode)return!1;if(s=e.data.data,a=s,!s)return!1;$.each(s.questions,function(e,t){if(t.id=t.question_id,t.type=u[t.question_channel_type],t.exam_type=d[t.exam_type],t.difficult_index=p[t.difficult_index],t.question_from=t.paper?'试题来源：<a href="/paper/view/'+t.paperid+'" target="_blank">'+t.paper.title+"</a>":"暂无来源",t.is_collect=t.is_collect?"取消收藏":"收藏",t.q_list="",7==t.question_type){var i="";$.each(t.list,function(e,t){t=$.extend({},t,{index:e}),i+=l(t),i+=c({q:t})}),t.q_list=i}});for(var i=o({data:s,user:USER}),n="",r=1;r<=e.data.len;r++)n+=1==r?'<li><a href="javascript:;" class="active">'+r+"</a></li>":'<li><a href="javascript:;">'+r+"</a></li>";$(".p-content").html(i),$(".p-con-num").html(n),$("input.cke_questions_blankInput").each(function(){$(this).replaceWith('<span class="q-blank">&nbsp;</span>')}),OT2.Util.calcItemWidth($(".exam-s").first());var f=$(".p-con-num li a"),h=$(".p-content ul li");$(".replace_anawer").css("display","block"),f.click(function(){f.removeClass("active"),$(this).addClass("active");var e=f.index(this);return $(".replace-btn").attr("index",e),h.hide().eq(e).show(),h.eq(e).find(".exam-s").each(function(){OT2.Util.calcItemWidth($(this))}),!1}),$(".search-exam").click(function(){$(this).parents(".beauty-man").find(".replace_anawer").each(function(){"none"==$(this).css("display")?$(this).show():$(this).hide()})})}})}),$(".p-replace-wrap").on("click",".replace-btn",function(){var t=a.questions[$(this).attr("index")],s={id:t.question_id,type:e.attributes.type,order:e.attributes.order,order2:e.attributes.order2,score:e.attributes.score,xd:t.xd,xk:t.chid},n=new OT2.Paper.Question(i,e.section,t,s);e.$el.after(n.$el),e.$el.remove(),n.$el.find(".q-sn").text(e.attributes.order2),i.publish("question:replace",e,n),i.renderSideTypes(),$(".shade-bg").remove(),$(".p-replace-wrap").remove(),$(document.body).css({"overflow-y":"auto"})})}})}),this.$el.find(".score-btn").on("click",function(){var t=OT2.Util.Template().get("dialog-score"),i=PARAMS.question_types||{},s=$(_.template(t,{self:e,qctypes:i}));$form=s.find("#dialog-score-form"),s.find("input").on("blur",function(){var e=parseFloat(this.value);this.value=isNaN(e)?0:e,n()});var n=function(){var e=0,t=[];return $form.find("input[name=score]").each(function(){var i=$(this).data("n")||null,s=Number(this.value)||0;e+=i?s*i:s,t.push(s)}),s.find(".s-total").html(e),{detail:t,score:e}};n();dialog({title:"分数设置："+e.attributes.type+" - 第（"+e.attributes.order2+"）题",content:s.get(0),fixed:!0,okValue:"确定",cancelValue:"取消",ok:function(){var t=n();e.attributes.score=t.score,e.attributes.subScore=t.detail[0]&&t.detail,e.serialize(),e.$el.find(".q-scoreval").html("（"+t.score+"分）"),e.section.publish("section:score"),e.paper.renderSideTypes()},cancel:function(){}}).showModal()})},transfer:function(){var e=$.Deferred(),t=$(_.template(OT2.Util.Template().get("dialog-transfer"),{self:this})),i=[],s="";t.find(".radiobox").each(function(){new OT2.Element.radio(this,i).bindEvent(function(){s=this.$input.val()})});var n=dialog({title:"试题转移",width:500,content:t.get(0),fixed:!0,okValue:"确定",cancelValue:"取消",ok:function(){e.resolve(s),n.close()},cancel:function(){}});return n.showModal(),e.promise()},sortable:function(){var t=this,i=$(document),s=!1,n=null,a=null,r=0,o=0,l=!1,c=0;this.$el.mousedown(function(i){if(s=!0,0==(a=t.$el.siblings()).length&&(s=!1),$(i.target).parents(".question-btngroup").length>0&&(s=!1),!s)return!1;var l=t.$el.width(),u=t.$el.height();(n=t.$el.clone()).attr("id","clone-div"),n.css({position:"absolute",width:l,height:u,"z-index":e.zIndex++}),t.section.$el.css("z-index",e.zIndex),x0=t.$el.offset().left,o=t.$el.offset().top,r=i.clientY-o,c=o,n.offset({left:x0,top:o}),$("#clone-div").length<1&&t.$el.parent().append(n),t.$el.addClass("dragging")}),i.mousemove(function(e){if(s){var i=e.clientY-r;n.offset({left:x0,top:i}),l=i>=c,c=i,a.each(function(){var e=$(this).offset().top,s=$(this).height();i>e&&i<e+s&&t.$el[l?"insertAfter":"insertBefore"](this)})}}),i.mouseup(function(){s&&(n.remove(),t.$el.removeClass("dragging"),t.enableSortable||t.section.publish("question:resort"),t.paper.renderSideTypes()),s=!1})},setScore:function(){}},e}();