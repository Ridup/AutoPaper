OT2.Paper.Section=function(){var e=function(e,t,n){OT2.Event.call(this),this._cid=_.uniqueId("type_"),this.paper=e,this.part=t,this.type=n.type,this.order=n.order,this.$el=null,this.$body=null,this.$order=null,this.sorting=!1,this.template=OT2.Util.Template().get("paper-section")};return e.prototype={init:function(){return this.render(),this.initEvents(),this},render:function(e){return this.$el=e||$(_.template(this.template,{self:this})),this.$body=this.$el.find(".paper-question-list").first(),this.$order=this.$el.find(".t-order"),this.$el.attr("_cid",this._cid),this},getCnOrder:function(){return OT2.Util.chinesesn(this.order)},getSize:function(){return this.getQuestions().length},getScore:function(){var e=this.getQuestions(),t=_.map(e,function(e){return e.attributes.score});return _.reduce(t,function(e,t){return Number(e+t)},0)},getQuestions:function(){var e=[];return this.paper.publish("question:sum",this,e),e},initEvents:function(){var e=this;e.$el.on("click",".J_SecSortGroup",function(){e.paper.askOrder(e._cid)}),e.$el.on("click",".J_DelQByType",function(){e.paper.deleteQuestions(e.type)});var t=OT2.Util.Template().get("dialog-mulscore");e.$el.find(".J_MultiSetScore").on("click",function(){var n=e.getQuestions();if(0==n.length)return!1;var i={};_.each(n,function(e){var t=e.model.question_channel_type,n=e.model.question_type;i[n]||(i[n]={}),i[n][t]?i[n][t].push(e):i[n][t]=[e]});var r=PARAMS.question_types,s=$(_.template(t,{data:i,qctypes:r,self:e}));$blanks=s.find("input[name=score]");var o=function(){var e=0;return $blanks.each(function(){e+=(Number(this.value)||0)*Number($(this).data("n"))}),i[6]&&_.each(i[6],function(t){_.each(t,function(t){e+=t.attributes.score})}),i[7]&&_.each(i[7],function(t){_.each(t,function(t){e+=t.attributes.score})}),s.find(".t-score").html(e),e};$blanks.on("blur",function(){o()}),o();dialog({title:"根据题型批量设置分数：",content:s.get(0),fixed:!0,okValue:"确定",cancelValue:"取消",ok:function(){$blanks.each(function(){var t=Number(this.value)||0,n=$(this).data("ct");e.publish("section:multi:setscore",t,n)})},cancel:function(){}}).showModal()}),e.paper.subscribe("question:changeType",function(t,n){n==e.type&&(e.type=t)}),e.$el.find("button.confirm").on("click",function(){e.$el.removeClass("paper-sorting"),e.paper.publish("question:sort",e.type,"disable"),e.publish("question:resort")}),e.subscribe("question:resort",function(){e.$body.find(".paper-question").each(function(t){e.paper.publish("question:setorder",this.id,++t)}),e.paper.publish("paper:questionlist:sort"),e.paper.serialize()}),e.$el.find("button.cancel").on("click",function(){e.$el.removeClass("paper-sorting"),e.paper.publish("question:sort",e.type,"disable");var t=e.$body.find(".paper-question");(t=t.sort(function(e,t){return $(e).find(".q-sn").html()-$(t).find(".q-sn").html()})).each(function(){e.$body.append(this)})}),e.paper.subscribe("question:destroy",function(t){t.attributes.type==e.type&&e.getQuestions().length&&(t.section=null,t=null,e.paper.publish("question:transfer:reform",e.type))}),e.paper.subscribe("question:deleteBatch",function(t){e.type==t&&(e.$el.remove(),e.part=null,e.paper.publish("section:resort",e))}),e.paper.subscribe("question:transfer",function(t,n,i){i==e.type&&(e.$body.append(t.$el),t.attributes.type=i,t.section=e,e.paper.publish("question:transfer:renderSideType",t.attributes.id,i),e.paper.publish("question:transfer:reform",n,i))}),e.paper.subscribe("question:transfer:reform",function(){var t=[].slice.call(arguments,0);if(!_.contains(t,e.type))return!1;e.$el.find(".t-num").html(e.getQuestions().length),e.publish("section:score"),e.publish("question:resort")}),e.paper.subscribe("section:resort",function(t){if(t==e)return!1;e.order=e.paper.$el.find(".paper-section").index(e.$el),e.paper.serialize(),e.$order.html(e.getCnOrder())}),e.subscribe("section:score",function(){var t=e.getQuestions(),n=_.reduce(t,function(e,t){return e+Number(t.attributes.score)},0);e.$el.find(".t-score").html(n)}),e.paper.subscribe("section:sum",function(t,n){e.part==t&&n.push(e)}),e.paper.subscribe("section:manual:resorting",function(t,n){t==e._cid&&(e.order=n,e.paper.attributes.types[e.type].order=n,e.$el.find(".t-order").html(e.getCnOrder()))})},initQuestionSort:function(e,t){var n=this,i=n.getQuestions();"function"==typeof t?i.sort(t):i.sort(function(e,t){return e.attributes.order-t.attributes.order});var r=0,s=i.length,o=0;_.map(i,function(t){n.$body.append(t.$el),void 0===e&&(e=0),++r,t.$el.find(".q-sn").html(e+r),t.attributes.order=r,t.attributes.order2=e+r;var i=n.paper.cacheObj[t.model.id];i&&(i.order=r),o+=Number(t.attributes.score)||0}),n.$el.find(".t-num").html(s),n.$el.find(".t-score").html(o)},scrolltoView:function(){var e=this;e.$el.addClass("sorting-section");var t=this.$el.offset().top-$(window).height()/3;$("html,body").animate({scrollTop:t},"slow"),setTimeout(function(){e.$el.removeClass("sorting-section")},2e3)}},_.extend(e.prototype,OT2.Event.prototype),e}();