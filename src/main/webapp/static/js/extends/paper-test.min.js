OT2.TestPaper=function(){var e=function(e,t,i){OT2.Event.call(this),this.attr=$.extend({},t),this.model=$.extend({},e),this.$el=i||$("#J_TestPaperBody"),this.$timer=$("#J_TimerClock"),this.$sheet=$("#J_PaperSheet"),this.start=!0,this.qNum=0};return e.prototype={init:function(){this.unserialize(),this.renderTimerClock(),this.startTest(),this.renderBody(),this.renderSheet(),this.listen(),this.initEvents()},renderBody:function(){var e=this,t=_.template("<h2><%= order %>、<%= type %></h2>");_.each(this.model.list,function(i,n){var s=t({order:OT2.Util.chinesesn(n),type:i.head_title,num:_.size(i.questions),score:0}),a=$('<div class="q-box"></div>');_.each(i.questions,function(t,i){var n=new OT2.TestPaper.Question(e,t);if("7"==t.question_type){var s=n.$el.find(".q-list");_.each(t.list,function(t,i){var a=new OT2.TestPaper.Question(e,t,n);s.append(a.$el)})}a.append(n.$el)}),e.$el.append(s),e.$el.append(a)}),e.intervalPublish("question:autowidth",100)},renderTimerClock:function(){var e=_.template(OT2.Util.Template().get("timer-clock")),t=this.secondsToRead(this.attr.usetime);this.$timer.empty().append($(e({timer:t})))},secondsToRead:function(e){var t=parseInt(e/3600,10).toString();t.length<2&&(t="0"+t),e%=3600;var i=parseInt(e/60,10).toString();i.length<2&&(i="0"+i);var n=(e%60).toString();return n.length<2&&(n="0"+n),[t,i,n]},startTest:function(){if(!this.start)return!1;var e=this,t=null,i=e.$timer.find("h3"),n=function(t){var n=e.secondsToRead(t);i.each(function(e){this.innerHTML=n[e]}),e.attr.usetime+=1},s=function(){t=setTimeout(function(){return!!e.start&&(n(e.attr.usetime),void s())},1e3)};s()},stopTest:function(e){if("undefined"==typeof USER.uid)return OT2.Global.initLogin(),!1;if(this.start=!this.start,"undefined"!=typeof e&&(e.innerHTML=this.start?"暂时保存":"开始测试"),this.start)return this.startTest(),!1;var t=this.cacheAnswers(),i=0,n=0;_.each(t,function(e){i++,null!==e&&n++});var s={pid:this.model.pid,task_id:this.model.task_id,answers:JSON3.stringify(t),percent:parseInt(n/i*100),FormulaImgHash:FormulaImgHash.getHash()};OT2.Util.alert("保存答案中"),$.post("/paper/save-answer",s,function(e){0===e.errCode||OT2.Util.alert("上传答案失败")},"json")},save:function(e){var t=this;if("undefined"==typeof USER.uid)return OT2.Global.initLogin(),!1;var i={pid:this.model.pid,task_id:this.model.task_id,answers:JSON3.stringify(this.cacheAnswers()),usetime:this.attr.usetime,FormulaImgHash:FormulaImgHash.getHash()};this.stopTest();var n=t.$sheet.find("a[data-idz]:not(.done)").length,s=function(){OT2.Util.alert("上传答案中"),$.post("/paper/upload-answer",i,function(e){0===e.errCode?(OT2.LocalData.remove(t.getKey()),window.location="/paper/report/"+e.data.result_id):OT2.Util.alert("上传答案失败")},"json")},a=n?"你还有<strong>"+n+"</strong>道题还没有完成，是否提交？":"提交并查看系统评分结果";a='<div class="test-save-tip">'+a+"</div>";var r=dialog({title:"完成测试",content:a,okValue:"确定",ok:function(){s(),r.close()},fixed:!0,cancelValue:"取消",cancel:function(){}});return n?(r.showModal(),!1):void s()},cacheAnswers:function(){var e={};return this.publish("question:get:answer",e),this.attr.answers=e,this.serialize(),e},renderSheet:function(){var e=_.template(OT2.Util.Template().get("testpaper-sheet"));this.$sheet.empty().append($(e({self:this})))},initEvents:function(){var e=this;this.$sheet.find("a[data-idz]").on("click",function(){var t=$(this).data("idz"),i=e.$el.find('[data-idx="'+t+'"]').first();i.find(".q-ordersn, .op-order").addClass("active-item"),setTimeout(function(){i.find(".q-ordersn, .op-order").removeClass("active-item")},2e3);var n=i.offset().top-document.documentElement.clientHeight/2+100;OT2.AboveIE9?$("html,body").animate({scrollTop:n},250):$("html,body").scrollTop(n)});var t=!1,i=function(){var e=document.body.scrollTop||document.documentElement.scrollTop;$(".answer-slide")[e>110?"addClass":"removeClass"]("answer-slide-fixed"),t=e>110},n=e.$sheet.height(),s=function(){var i=$(window).height();return i=t?i-190:i-300,n<i?(e.$sheet.height(n+10),!1):(e.$sheet.css({height:i}),void e.$sheet.addClass("overflow"))};$(window).on("scroll",i),$(window).on("resize",s),$(window).on("scroll",s),s()},getKey:function(){return["testpaper",this.model.uid,this.model.pid].join(":")},getTypeName:function(e){var t=e.indexOf("：");return t<=0?e:e.slice(0,t)},listen:function(){var e={};this.$sheet.find("a[data-idz]").each(function(){e[$(this).data("idz")]=$(this)}),this.subscribe("question:do",function(t,i){var n=t.model.question_id+("undefined"==typeof i?"":"."+i);if("136".indexOf(t.model.question_type)>-1)e[n].addClass("done");else if("2"==t.model.question_type)e[n][t.myanswer?"addClass":"removeClass"]("done");else if("4"==t.model.question_type){var s=!0;t.myanswer||(s=!1),_.size(t.myanswer)!=_.size(t.model.myanswer)&&(s=!1),e[n][s?"addClass":"removeClass"]("done")}else"5"==t.model.question_type&&e[n][t.myanswer?"addClass":"removeClass"]("done")})},serialize:function(){OT2.LocalData.set(this.getKey(),JSON3.stringify(this.attr))},unserialize:function(){var e=OT2.LocalData.get(this.getKey()),t={};try{t=JSON3.parse(e)}catch(i){}this.attr=e?t:this.attr}},_.extend(e.prototype,OT2.Event.prototype),e}(),OT2.TestPaper.Question=function(){var e=function(e,t,i){this.paper=e,this.model=t,"undefined"!=typeof i&&(this.parent=i),this.$el=null,this.qNum=0,this.initMyAnswer(),this.autoAllocNumber(),this.init()};return e.prototype={init:function(){this.render(),this.initEvents()},autoAllocNumber:function(){"0"==this.model.parent_id?(this.paper.qNum+=1,this.id=this.paper.qNum):(this.parent.qNum+=1,this.id=this.parent.qNum)},initMyAnswer:function(){this.myanswer=this.paper.attr.answers[this.model.question_id]||null},tempalte:_.template(OT2.Util.Template().get("question-style")),render:function(){var e=this;e.$el=$(e.tempalte({self:e}));var t=e.$el.find(".cke_questions_blankInput"),i=1;return t.each(function(){$(this).after('<span class="q-blank">&nbsp;</span>'),i++}),t.remove(),e},initEvents:function(){this.bindEvents(),this.radioAndCheckbox(),this.listen()},radioAndCheckbox:function(){var e=this;this.$el.find(".op-items").each(function(t){var i=[];$(this).find(".radiobox").each(function(){new OT2.Element.radio(this,i).bindEvent(function(){var i=this.$input.val();"1"!=e.model.question_type&&"3"!=e.model.question_type||(e.myanswer=i,e.paper.publish("question:do",e)),"6"==e.model.question_type&&(e.myanswer=e.myanswer||{},e.myanswer[t+1]=i,e.paper.publish("question:do",e,t+1))})});var n=[];$(this).find(".checkbox").each(function(){new OT2.Element.checkbox(this,n).bindEvent(function(){if("2"==e.model.question_type){e.myanswer=e.myanswer||[];var t=this.$input.val();this.checked?e.myanswer.push(t):e.myanswer=_.reject(e.myanswer,function(e){return e==t}),0==e.myanswer.length&&(e.myanswer=null),e.paper.publish("question:do",e)}})})})},bindEvents:function(){var e=this;if("4"==this.model.question_type){var t=e.myanswer||{},i=this.$el.find(".fill-edit");i.on("keyup fillblank",function(){i.each(function(e){var i=$.trim(this.innerHTML);delete t[e+1],i.length&&(t[e+1]=i)}),e.myanswer=t,0==_.size(t)&&(e.myanswer=null),FormulaImgHash.answers[e.model.question_id]=e.myanswer,$(this)[e.myanswer?"addClass":"removeClass"]("done-textarea"),e.paper.publish("question:do",e)})}else"5"==this.model.question_type&&this.$el.find(".fill-edit").on("keyup fillblank",function(t,i){var n=$.trim(this.innerHTML);"undefined"!=typeof i&&(n=$.trim(i)),e.myanswer=n.length>0?n:null,FormulaImgHash.answers[e.model.question_id]=e.myanswer,$(this)[e.myanswer?"addClass":"removeClass"]("done-textarea"),e.paper.publish("question:do",e)})},listen:function(){var e=this;this.paper.subscribe("question:autowidth",function(){if("1236".indexOf(e.model.question_type)==-1)return!1;var t=e.$el.find(".op-items");t.each(function(){OT2.Util.calcItemWidth($(this))})}),this.paper.subscribe("question:get:answer",function(t){t[e.model.question_id]=e.myanswer})}},e}();