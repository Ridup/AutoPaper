OT2.Paper=function(){var t={1:"密封线",2:"大题评分区",3:"主标题",4:"注意事项",5:"副标题",6:"分卷",7:"考试时间",8:"分卷注释",9:"考生填写",10:"分大题",11:"总评分",12:"大题注释"},e={simple:{name:"简易模板",val:"3 10 12".split(/\s+/)},common:{name:"普通模板",val:"3 4 5 7 9 10 11 12".split(/\s+/)},normal:{name:"正式模板",val:"1 2 3 4 5 6 7 8 9 10 11 12".split(/\s+/)}},i={"单选题":{name:"单选题",order:1,part:1},"多选题":{name:"多选题",order:2,part:1},"判断题":{name:"判断题",order:3,part:1}},n=function(t,i){OT2.Event.call(this),i=void 0===i?{}:i,this.$el=$("#J_PaperLayout"),this.$body=$("#J_PaperBody"),this.editableInput=null,this.attributes={template:"simple",setting:_.clone(e.simple.val),title:"",subtitle:"",xd:"",xk:"",xdName:"",xkName:"",notes:"1、填写答题卡的内容用2B铅笔填写<br>2、提前 xx 分钟收取答题卡",paperPart:{1:{name:"第Ⅰ卷 客观题",tip:"第Ⅰ卷的注释"},2:{name:"第Ⅱ卷 主观题",tip:"第Ⅱ卷的注释"}},types:i,examtime:"* *",score:"* *",sheet:"1",expires:(new Date).getTime()},_.extend(this.attributes,t),this.paper_key=["paper2016",this.attributes.xd,this.attributes.xk].join(":"),this.pid=null,this.cacheObj={},this.verify=null,this.verify_code=null,this.verify_call=!1,this.basketQids=[]};return n.prototype={init:function(t,e){var i=this;if(void 0!==e&&e&&(_.each(t,function(t,e){i.cacheObj[t.id]={id:t.id,order:e+1,type:t.type,xd:t.xd,xk:t.xk}}),OT2.LocalData.set("basket_cacheObj_v2",JSON3.stringify(i.cacheObj))),this.unserialize(),void 0!==t)return i.render(t),i;this.fetchQuestionsDetail("/getQuestionsByCategory").done(function(t){i.render(t)})},render:function(t){this.renderBody(t),this.bindEvent(),this.renderPagerHeader(),this.renderSideSet(),this.renderSideTypes(),this.initNewSideTypeDrag(),this.initNewSideGridDrag(),this.intervalPublish("question:width",150),this.manual_events()},renderSideTypes_old:function(){var t=OT2.Util.Template().get("paper-types"),e=this.getList().length,i=[],n=this.getParts();n.sort(function(t,e){return t.id-e.id});for(var s,a=0;s=n[a++];){var r=s.getSections();r.sort(function(t,e){return t.order-e.order});for(var o,d=0;o=r[d++];){var c=o.getQuestions().length;i.push({type:o.type,size:c})}}var l=$(_.template(t,{self:this,size:e,data:i}));this.$sideTypes=$("#J_PaperTypes"),this.$sideTypes.empty().append(l);var t=OT2.Util.Template().get("paper-score"),u=$(_.template(t,{self:this}));$("#J_PaperScore").empty().append(u)},manual_events:function(){var t=this;this.$el.on("click",".toggle-sd-box",function(){var e=$(this).parent("h3").next("div"),i=!e.is(":visible");e[i?"show":"hide"](),this.innerHTML=i?"收起":"展开",t.autoHeightSideType()}),this.$sideTypes.on("click",".drag-grid",function(e){var i=$(this).attr("_qid");t.publish("question:scrolltoview",i)})},renderSideTypes:function(){var t=[],e=0,i=0,n=0,s={"容易":[0,1.7],"普通":[1.7,2.4],"困难":[2.4,1/0]},a=this.getParts().sort(function(t,e){return t.id-e.id});_.each(a,function(s,a){var r=s.getSections().sort(function(t,e){return t.order-e.order});_.each(r,function(s,a){var r=s.getQuestions().sort(function(t,e){return t.attributes.order-e.attributes.order}),o=s.type.substr(0,8);o=o.length>7?o+"...":o,t.push({type:s.type,short_type:o,_cid:s._cid,list:r}),_.each(r,function(t,s){i++,e+=t.attributes.score;var a=Number(t.model._difficult_index)||Number(t.model.difficult_index);3==a?a=2:5==a&&(a=3),n+=a||0})})}),i&&(n/=i,_.each(s,function(t,e){if(n>t[0]&&n<=t[1])return n=e,!1}));var r=OT2.Util.Template().get("paper-club"),o=$(_.template(r,{data:t,score:e,num:i,dd:n}));this.$sideTypes=$("#J_PaperTypes"),this.$sideTypes.html(o);var r=OT2.Util.Template().get("paper-score"),d=$(_.template(r,{self:this}));$("#J_PaperScore").empty().append(d)},getParts:function(){var t=[];return this.publish("part:sum",t),t},getList:function(){var t=[];return this.publish("question:list",this,t),t},initSideTypeDragSorting:function(){return!1},resortSections:function(){var t=this;t.$el.find(".paper-section").each(function(e){var i=$(this).attr("_cid");t.publish("section:manual:resorting",i,e)})},initNewSideTypeDrag:function(){var t=this;$doc=$(document);var e=!1,i=!1,n=null,s=null,a=null,r=null,o=100,d=!1,c=0,l=0,u=0,h=0,p=0,f=0,v=0;this.$sideTypes.on("mousedown","div.drag-wire",function(t){$("html,body").stop(),i=!0;var e=$(t.target);if((e.hasClass("t-del")||e.hasClass("t-order")||e.hasClass("drag-grid"))&&(i=!1),n=$(this),0==(a=n.siblings()).length&&(i=!1),!i)return!1;a.each(function(){this._offset=$(this).offset()}),f=n.width(),v=n.height(),(s=n.clone()).attr("id","clone-drag-wire"),s.css({position:"absolute",width:f,height:v,"z-index":o++});var r=n.offset();u=r.left,h=r.top,l=t.clientY-h,c=t.clientX-u,p=h,s.offset({left:u,top:h}),$("#clone-drag-wire").length<1&&n.parent().append(s)}),$doc.on("mousemove",_.throttle(function(t){if(i){e=!0,n.addClass("drag-wire-dragging");var o=t.clientX-c,h=t.clientY-l;s.offset({left:u,top:h}),r=null,a.each(function(){var t=$(this),e=this._offset,i=e.top,s=e.left,a=t.height(),c=t.width();if(!(o>s+c||h>i+a||o+f<s||h+v<i))return r=this,d=h>p,p=h,n[d?"insertAfter":"insertBefore"](r),!1})}},50)),$doc.on("mouseup",function(o){if(i&&e&&r){var c=d?"insertAfter":"insertBefore",l=n.data("typename"),u=$(r).data("typename"),h=t.getSectionByType(l),p=t.getSectionByType(u);h.part=p.part,t.attributes.types[l].part=p.part.id,h.$el[c](p.$el),h.$el.addClass("sorting-section"),h.scrolltoView(),t.resortSections(),t.initQuestionListSort(),t.renderSideTypes(),t.serialize()}i&&(n&&n.removeClass("drag-wire-dragging"),s&&s.remove(),s=null,e=!1,i=!1,n=null,a=null,r=null)})},initNewSideGridDrag:function(){var t=this,e=$(document),i=!1,n=!1,s=null,a=null,r=null,o=null,d=0,c=0,l=0,u=0,h=!1,p=0,f=500,v=0,b=0;this.$sideTypes.on("mousedown",".drag-grid",function(t){if($("html,body").stop(),t.stopPropagation(),n=!0,o=$(this),0==(a=o.siblings()).length&&(n=!1),!n)return!1;a.each(function(){this._offset=$(this).offset()}),v=o.width(),b=o.height(),(s=o.clone()).attr("id","clone-drag-grid"),s.css({position:"absolute",width:v,height:b,"z-index":f++});var e=o.offset();l=e.left,u=e.top,d=t.clientX-l,c=t.clientY-u,p=l,s.offset({left:l,top:u}),$("#clone-drag-grid").length<1&&o.parent().append(s)}),e.on("mousemove",_.throttle(function(t){if(n){i=!0,o.addClass("grid-dragging");var e=t.clientX-d,l=t.clientY-c;s.offset({left:e,top:l}),r=null,a.each(function(){var t=$(this),i=this._offset,n=i.left,s=i.top,a=t.width(),d=t.height();if(!(e>n+a||l>s+d||e+v<n||l+b<s))return h=e<p,p=e,r=this,o[h?"insertBefore":"insertAfter"](r),!1})}},50)),e.on("mouseup",function(e){if(n&&i){o.parent().find(".drag-grid").each(function(e){if("clone-drag-grid"==this.id)return!0;var i=$(this).attr("_qid");t.publish("question:setorder","question-"+i,e)}),t.publish("paper:questionlist:sort"),t.renderSideTypes(),t.publish("question:scrolltoview",o.attr("_qid")),t.serialize()}n&&(o&&o.removeClass("grid-dragging"),a&&a.removeClass("grid-crash"),s&&s.remove(),i=!1,n=!1,s=null,o=null,a=null,r=null)})},resortSideGrids:function(){},getSectionByType:function(t){var e=null,i=this.getParts();return _.each(i,function(i){var n=i.getSections();_.each(n,function(i){if(t==i.type)return e=i,!1})}),e},getSectionByCid:function(t){var e=null;return _.each(this.getParts,function(i){_.each(i.getSections,function(i){if(t===i._cid)return e=i,!1})}),e},getPartById:function(t){var e=this.getParts();return _.find(e,function(e){return e.id==t})},getAllSection:function(){var t=[],e=this.getParts();return _.each(e,function(e){t=t.concat(e.getSections())}),t},renderBody:function(t){var e=this,n={};_.each(t,function(t){if(t&&t.id&&_.contains(e.basketQids,t.id)){var i=e.cacheObj[t.id]||{},s=i.type||t.type;n[t.id]={model:t,attr:i,type:s}}});var s=_.sortBy(e.cacheObj,"order");_.each(s,function(t){if(t.new_model&&t.xd==e.attributes.xd&&t.xk==e.attributes.xk){var i=t||{},s=i.type||t.new_model.type;n[t.id]={model:t.new_model,attr:i,type:s}}}),uuu=$.extend(!0,{},n),n=_.sortBy(n,function(t){return t.attr.order-0});var a=_.uniq(_.map(n,function(t){return t.type})),r={},o=0;_.each(a,function(t,e){r[t]=i[t]?$.extend({},i[t],{order:o++}):{name:t,order:o++,part:2}}),e.attributes.types=$.extend({},r,e.attributes.types),e.serialize();e.$body.empty();var d=0;_.map(e.attributes.paperPart,function(t,i){var n={id:i,name:t.name,tip:t.tip,order:d++};new OT2.Paper.Part(e,n).init()});var c=e.getParts();c=_.sortBy(c,"order");var l=0,u=_.sortBy(e.attributes.types,"order");_.each(c,function(t){_.each(u,function(i,s){var a=i.name;if(t.id==i.part){var r={order:l,type:a};e.attributes.types[a].order=l;var o=new OT2.Paper.Section(e,t,r);o.init(),_.chain(n).sortBy(function(t){return t.attr.sort-0}).each(function(t,i){if(t.type==a){var n=new OT2.Paper.Question(e,o,t.model,t.attr);o.$body.append(n.$el)}}),t.$el.append(o.$el),l++}}),e.$body.append(t.$el)}),e.initQuestionListSort(),e.serialize()},initQuestionListSort:function(){var t=this;t.subscribe("paper:questionlist:sort",function(){var e=t.getAllSection();e=_.sortBy(e,"order");var i=0;_.each(e,function(t){t.initQuestionSort(i),i+=t.getQuestions().length})}),t.publish("paper:questionlist:sort")},renderPagerHeader:function(){var t=this;this.$el.find(".contenteditable").each(function(){var e=$(this).data("edit");_.contains(["title","subtitle","examtime","score","notes"],e)&&$(this).html(t.attributes[e])})},fetchQuestionsDetail:function(t){var e=$.Deferred();return $.post(t,{list:this.basketQids},"json").done(function(t){e.resolve(t)}),e.promise()},serialize:function(){this.pid&&(this.pid=null),OT2.LocalData.set(this.paper_key,JSON3.stringify(this.attributes)),OT2.LocalData.set("basket_cacheObj_v2",JSON3.stringify(this.cacheObj))},unserialize:function(){var t=null;try{t=JSON3.parse(OT2.LocalData.get(this.paper_key))}catch(t){}var e=(new Date).getTime();t&&(e-=t.expires,0==t.expires?this.attributes=t||this.attributes:e<6048e5&&(t.expires=(new Date).getTime(),this.attributes=t||this.attributes));var i={};try{i=JSON3.parse(OT2.LocalData.get("basket_cacheObj_v2"))}catch(t){}this.cacheObj=i||{},this.getPaperBasketQids()},stringify:function(){var t=this,e={content:[],title:t.attributes.title,subtitle:t.attributes.subtitle,xd:t.attributes.xd,chid:t.attributes.xk,notes:t.attributes.notes,examtime:"考试时间："+t.attributes.examtime+"&nbsp;分钟&nbsp;&nbsp;&nbsp;&nbsp;满分："+t.attributes.score+"&nbsp;分",paperPart:t.attributes.paperPart,setting:t.attributes.setting},i={};try{i=JSON3.parse(OT2.LocalData.get("basket_cacheObj_v2"))||{}}catch(t){}var i=_.sortBy(i,"order"),n=_.sortBy(t.attributes.types,"order");return _.each(n,function(n,s){var a={head_title:n.name,questions:[],scores:{}};_.each(i,function(e,i){if(e.type==n.name&&e.xd==t.attributes.xd&&e.xk==t.attributes.xk){a.questions.push(e.id);var s={score:"4"};void 0!==e.subScore&&(s.subScore=e.subScore),void 0!==e.score&&(s.score=e.score),a.scores[e.id]=s}}),e.content.push(a)}),e},getPaperBasketQids:function(){var t=this;return t.basketQids=[],_.each(t.cacheObj,function(e,i){t.basketQids.push(e.id)}),t.basketQids},getSetting:function(){return t},getPaperSet:function(){return e},renderSideSet:function(){var t=this,e=OT2.Util.Template().get("paper-template"),i={setting:this.getSetting(),paperset:this.getPaperSet(),attr:this.attributes};this.$set=$(_.template(e,i)),$("#J_PaperSetRadio").empty().append(this.$set),e=OT2.Util.Template().get("paper-setoptions"),this.$setopt=$(_.template(e,i)),$("#J_PaperSetCheck").empty().append(this.$setopt);var n=[],s=[];this.$set.find(".radiobox").each(function(){new OT2.Element.radio(this,n).bindEvent(function(){t.attributes.template=this.$input.val(),t.publish("paper:template",this.$input.val())})}),this.$setopt.find(".checkbox").each(function(){var e=new OT2.Element.checkbox(this,s);e.bindEvent(function(){t.publish("paper:setting",this.checked,this.$input.val()),1==this.$input.val()&&t.publish("question:width")}),t.publish("paper:setting",e.checked,e.$input.val()),t.subscribe("paper:template",function(i){var n=t.getPaperSet()[i].val,s=e.$input.val(),a=!1;_.contains(n,s)&&(a=!0),e.switchChecked(a,function(){t.publish("paper:setting",this.checked,this.$input.val())})})})},bindEvent:function(){var t=this;this.bindContentEditArea(),this.bindPaperSetting(),this.subscribe("question:destroy",function(e){t.destroyQuestionById(e.model.id,e),t.publish("paper:questionlist:sort"),t.renderSideTypes()}),this.subscribe("question:destroyBatch",function(e){t.destroyQuestionById(e.model.id,e),t.renderSideTypes()}),this.subscribe("question:replace",function(e,i){t.replaceQuestion(e,i)}),this.subscribe("question:transfer:renderSideType",function(e,i){t.cacheObj[e].type=i,t.serialize(),t.renderSideTypes()}),$(document).on("keyup",function(e){13==e.keyCode&&t.editableInput&&t.editableInput.is("input")&&t.editableInput.blur()}),$(window).on("scroll",_.throttle(function(){t.fixedSide()},100)),$(window).on("resize",_.debounce(function(){t.autoHeightSideType()},100))},replaceQuestion:function(t,e){delete e.model.q,this.cacheObj[e.attributes.id]=$.extend(!0,{},e.attributes,{new_model:e.model}),delete this.cacheObj[t.attributes.id],t.paper=null,t.section=null,t=null,this.publish("question:width"),this.serialize()},deleteQuestions:function(t){var e=this;dialog({title:"友情提示",content:'你确定要删除"'+t+'"吗?',padding:20,okValue:"确定",cancelValue:"取消",ok:function(){e.doDeleteQuestions(t)},cancel:function(){this.close()}}).showModal()},doDeleteQuestions:function(t){this.publish("question:deleteBatch",t),delete this.attributes.types[t],this.publish("paper:questionlist:sort"),this.serialize(),this.renderSideTypes()},renderSideOrder:function(t){var e=[],i=this.getParts().sort(function(t,e){return t.id-e.id});_.each(i,function(t,i){var n=t.getSections().sort(function(t,e){return t.order-e.order});_.each(n,function(t,i){var n=t.type.substr(0,8);n=n.length>7?n+"...":n,e.push({_cid:t._cid,type:t.type,short_type:n})})});var n=$(_.template(OT2.Util.Template().get("club-sort"),{data:e,_cid:t})),s=[],a=[];return n.find(".custom-checkbox").each(function(){new OT2.Element.checkbox(this,s).bindEvent()}),n.find(".custom-radio").each(function(){new OT2.Element.radio(this,a).bindEvent()}),n},askOrder:function(t){var e=this,i=this.renderSideOrder(t);dialog({title:"试题排序",content:i,okValue:"确定",cancelValue:"取消",width:600,ok:function(){var t=i.find("form").serializeArray(),n=[],s=1;_.each(t,function(t,e){"type[]"===t.name&&n.push(t.value),"orderby"===t.name&&(s=t.value)}),e.multi_resort_questions(n,s)},cancel:function(){this.remove()}}).showModal()},multi_resort_questions:function(t,e){var i=_.sortBy(this.getAllSection(),"order"),n=0;_.each(i,function(i){_.contains(t,i._cid)&&i.initQuestionSort(n,function(t,i){var n=Number(t.model._difficult_index-i.model._difficult_index)||0;return 0==(n*=e)&&(n=Number(i.model.question_id-t.model.question_id)||0),n}),n+=i.getQuestions().length}),this.serialize(),this.renderSideTypes()},bindPaperSetting:function(){var t=this;this.subscribe("paper:setting",function(e,i){t.$el.find("[data-paperset]").each(function(){i==$(this).data("paperset")&&$(this)[e?"show":"hide"]()}),t.attributes.setting=_.uniq(t.attributes.setting),e?t.attributes.setting.push(i):t.attributes.setting=_.reject(t.attributes.setting,function(t){return t==i})})},bindContentEditArea:function(){this.listenContenteditable();var t=this;this.$el.on("click",".contenteditable",function(){var e=this,i=$(this).data("edit");if(void 0===this._input){this._input="notes"==i?$("<textarea>"):$("<input>"),this._input.insertAfter(this);var n=this.innerHTML;this._input.on("blur",function(){n=$(this).data("oldvalue")||n,$(e).show(),$(this).hide();var s=$.trim(this.value);if(!s)return!1;"notes"==i&&(this.value=s.replace(/\n/g,"<BR>")),$(e).html(this.value),$(this).data("oldvalue",this.value),t.publish("paper:contenteditable",i,this.value,e,n),t.editableInput=null})}t.editableInput=this._input,this._input.show(),this._input.focus();var s=this.innerHTML;"notes"==i&&(s=s.replace(/<br>|<BR>/g,"\n")),this._input.val(s),$(this).hide()})},listenContenteditable:function(){var t=this;this.subscribe("paper:contenteditable",function(e,i,n,s){if(_.contains(["title","subtitle","examtime","score","notes"],e))t.attributes[e]=i;else if("paperPart.name"==e||"paperPart.tip"==e){var a=$(n).data("part"),r="tip";"paperPart.name"==e&&(r="name"),t.attributes.paperPart[a][r]=i}else"type"==e&&(t.publish("question:changeType",i,s),t.attributes.types[i]=$.extend({},t.attributes.types[s]),t.attributes.types[i].name=i,delete t.attributes.types[s],t.renderSideTypes());t.serialize()})},addNewType:function(){var t=this,e=$(_.template(OT2.Util.Template().get("add-type"),{})),i=e.find("input"),n=e.find(".error-msg"),s=dialog({title:"添加自定义题型",content:e.get(0),okValue:"确定",ok:function(){var e=$.trim(i.val()),a="";if(e.length<=0?a="题型名称不能为空！":(e.length>10||e.length<3)&&(a="题型名称3-10个字符！"),n[a?"show":"hide"](),n.html(a),a)return!1;t.insertNewType(e),s.close()},fixed:!0,cancelValue:"取消",cancel:function(){}});s.showModal()},insertNewType:function(t){if(this.attributes.types[t])return!1;var e=_.size(this.attributes.types);this.attributes.types[t]={name:t,order:e,part:2},this.serialize();var i=this.getPartById(2),n={type:t,order:e},s=new OT2.Paper.Section(this,i,n);s.init(),i.$el.append(s.$el),this.renderSideTypes(),s.scrolltoView()},destroyQuestionById:function(t,e){delete this.cacheObj[t],void 0!==e&&(e.paper=null,e.section=null,e=null),this.serialize()},checkVerify:function(){var t=$("input[name=verifycode]").val();if(""==t)return OT2.Util.alert("请输入验证码"),!1;this.verify_code=t,this.verify_call()},check_err:function(t){var e=this;e.pid||e.verify||e.verify_code||($.ajaxSettings.async=!1,$.getJSON("/paper/check-verify",{},function(i){$.ajaxSettings.async=!0,403==i.errCode?(e.verify=!0,OT2.Util.verify(t)):e.verify=!1}))},save:function(){var t=this;t.saveProcess(function(){t.pid;var e=OT2.Util.Template().get("dialog-save"),i=$(_.template(e,{pid:t.pid}));i.find("a").click(function(){return window.location.replace(this.href),!1});var n=dialog({title:"提示",content:i.get(0),fixed:!0});n.showModal(),i.find("#b-download").click(function(){t.download(),n.close()}),i.find("#b-share").click(function(){t.shareDialog(),n.close()})})},refreshCaptcha:function(){$.get("/site/captcha",{refresh:1},function(t){$("#zujuan-captcha").attr("src",t.url)})},saveProcess:function(t){var e=this;if(e.pid)return t(),!1;var i=this.stringify();i.pid=e.pid,e.verify_code&&(i.verifyCode=e.verify_code),$.post("/paper/create",i,function(i){if(0==i.errCode){e.verify=!1,e.verify_code=null,dialog({id:"checkform"}).close(),e.pid=i.data.pid,OT2.LocalData.remove(e.paper_key);var n={};try{n=JSON3.parse(OT2.LocalData.get("basket_cacheObj_v2")),_.each(n,function(t,i){t.xd==e.attributes.xd&&t.xk==e.attributes.xk&&delete n[i]})}catch(t){}OT2.LocalData.set("basket_cacheObj_v2",JSON3.stringify(n)),t()}else 400==i.errCode?(e.refreshCaptcha(),e.verify_code=null,e.verify=null,OT2.Util.alert("图形验证码错误,请重新填写")):OT2.Util.alert(i.message)},"json")},adminSave:function(t,e){var i=this;i.pid=t;var n=this.stringify();$.post("/paper/admin-create?pid="+i.pid+"&type="+e,n,function(t){0==t.errCode?(i.pid=t.data.pid,OT2.LocalData.remove(i.paper_key),OT2.LocalData.remove("basket_cacheObj_v2"),OT2.LocalData.remove("basket_cachePid"),OT2.Util.alert("试卷保存成功"),window.location.replace("/paper/view/"+i.pid)):OT2.Util.alert("试题保存失败,请检查试卷排版")},"json")},download:function(t){var e=this;if(void 0!==t&&(e.pid=t),void 0===USER.uid)return OT2.Global.initLogin(),!1;e.saveProcess(function(){var t;$.ajax({url:"/paper/download-params",data:{pid:e.pid},dataType:"json",async:!1,success:function(e){t=e.data}});var i={chooseType:"student",chooseSize:"A4",renderMathAsImg:1,chooseContent:["an"]};t.isCan||("充值学币",DDDD=function(){window.location.replace("http://www.21cnjy.com/pay/")});var n=[],s=[],a=[],r=t.view,o=$(_.template(r,{}));o.find(".download-size .radiobox").each(function(){new OT2.Element.radio(this,n).bindEvent(function(){i.chooseSize=this.$input.val()})}),o.find(".download-type .radiobox").each(function(){new OT2.Element.radio(this,s).bindEvent(function(){i.chooseType=this.$input.val()})}),o.find(".download-math .radiobox").each(function(){new OT2.Element.radio(this,a).bindEvent(function(){i.renderMathAsImg=this.$input.val()})}),o.find(".download-type .checkbox").click(function(){var t=$(this).find("input").val();$(this).hasClass("checked")?(i.chooseContent.splice($.inArray(t,i.chooseContent),1),$(this).removeClass("checked"),$(this).find("input").removeAttr("checked")):(i.chooseContent.push(t),$(this).addClass("checked"),$(this).find("input").attr("checked",""))}),o.find("button.recharge-btn").on("click",function(){c.close(),OT2.Util.alert("生成试卷,请耐心等待"),window.location="/paper/download?pid="+e.pid+"&size="+i.chooseSize+"&type="+i.chooseType+"&content_type="+i.chooseContent+"&renderMathAsImg="+i.renderMathAsImg});if(!t.isCan)var d=setInterval(function(){$.get("/payment/check-order",{pid:e.pid,username:USER.username},function(t){"success"==t&&(o.find(".down_btn .recharge-btn").first().trigger("click"),void 0!==d&&clearInterval(d))})},1e3);var c=dialog({title:"下载word试卷",content:o,width:450,onclose:function(){void 0!==d&&(clearInterval(d),d=null)}});c.showModal()})},showPie:function(t){if(void 0!==t&&(this.pid=t),this.pid)OT2.PaperAnalysis.show("/paper/pie/"+this.pid);else if(!this.pid){var e={},i=JSON3.parse(OT2.LocalData.get("basket_cacheObj_v2")),n=this.stringify();_.each(i,function(t,i){e[t.id]=t.id}),$.post("/paper/pie",{qids:e,content:n.content},function(t){0==t.errCode&&OT2.PaperAnalysis.show1(t.data)})}},shareDialog:function(t){void 0!==t?this.pid=t:this.pid||OT2.Util.alert("请先保存试卷");var e={title:this.attributes.title},i="";if($.ajax({url:"/paper/share-info",data:{pid:this.pid},dataType:"json",async:!1,success:function(t){e=t.data,0!=t.errCode&&(i=t.message)}}),""===i){e.pid=this.pid;var n=OT2.Util.Template().get("dialog-share"),s=$(_.template(n,e)),a=dialog({title:"试卷共享编辑",content:s.get(0),okValue:"确定",cancelValue:"取消",ok:function(){var t=s.find("#share-form").serializeArray();$.post("/paper/share",t,function(t){0==t.errCode?OT2.Util.alert("试卷分享成功"):OT2.Util.alert(t.message)},"json"),a.close()},cancel:function(){}});a.showModal()}else OT2.Util.alert(i)},collectPaper:function(t,e){void 0!==t?this.pid=t:this.pid||OT2.Util.alert("请先保存试卷"),$.get("/paper/collect",{pid:this.pid},function(t){0==t.errCode?(OT2.Util.alert(t.message),e("收藏成功"==t.message)):OT2.Util.alert(t.message)})},setAnswerSheet:function(t){var e=this;void 0!==t&&(e.pid=t),e.pid,e.saveProcess(function(){var t=e.attributes.sheet,i=OT2.Util.Template().get("dialog-answer-sheet"),n=$(_.template(i,{self:e}));n.vmenu=n.find(".menu"),n.vsheetlist=n.find(".sheet-list"),n.vtit=n.find(".s-title"),n.vsheets=n.find(".sheet div"),n.vmenu.on("click",function(){n.vsheetlist.show(),$(this).addClass("active")}),n.vsheetlist.find("li").on("click",function(e){e.stopPropagation(),n.vsheetlist.hide(),n.vtit.html(this.innerHTML),t=$(this).data("sheet"),n.vsheets.hide(),n.vsheets.eq(t-1).show(),n.vmenu.removeClass("active")}),$(document).on("click",function(t){0!=$(t.target).parents(".menu").length||$(t.target).hasClass("menu")||(n.vsheetlist.hide(),n.vmenu.removeClass("active"))}),n.vsheetlist.find('li[data-sheet="'+t+'"]').click();dialog({title:"下载答题卡",content:n.get(0),okValue:"确定",cancelValue:"取消",ok:function(){e.attributes.sheet=t,OT2.Util.alert("生成试卷答题卡中,请耐心等待"),window.location="/paper/download-answer-sheet?pid="+e.pid+"&size="+{1:"c",2:"a",3:"b"}[t],e.serialize()},cancel:function(){}}).showModal()})},fixedSide:function(){var t=document.body.scrollTop||document.documentElement.scrollTop;this.isFixedSide=t>110,this.$el[this.isFixedSide?"addClass":"removeClass"]("fixed"),this.autoHeightSideType()},autoHeightSideType:function(){var t=document.documentElement.clientHeight;void 0===this.sideTypes_Height&&(this.sideTypes_Height=this.$sideTypes.height());var e=$("#sd-set-wire"),i=e.height();e.is(":visible")||(i=0),t=this.isFixedSide?t-i-190-56:t-i-300-56,this.sideTypes_Height<t?(this.$sideTypes.css({height:"auto"}),this.$sideTypes.removeClass("overflow")):(this.$sideTypes.css({height:t}),this.$sideTypes.addClass("overflow"))}},_.extend(n.prototype,OT2.Event.prototype),n}();